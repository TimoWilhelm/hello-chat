<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Chat Demo</title>
		<style>
			#messageContainer {
				border: 1px solid #ccc;
				padding: 10px;
				margin: 10px 0;
				height: 200px;
				overflow-y: auto;
			}
			#sessionInfo {
				background: #f0f0f0;
				padding: 5px 10px;
				border-radius: 4px;
				margin: 10px 0;
				font-family: monospace;
			}
		</style>
	</head>
	<body>
		<h1>Actor Sockets Demo</h1>
		<div id="connectionStatus">Status: Disconnected</div>
		<div id="messageContainer"></div>

		<form onsubmit="sendMessage(event)" action="">
			<input type="text" id="messageInput" placeholder="Type your message" />
			<button type="submit">Send Message</button>
			<button type="button" onclick="disconnect()">Disconnect</button>
		</form>

		<script>
			const url = new URL(window.location.href);
			let room = url.searchParams.get('room');

			if (!room) {
				room = generateRandomId();
				url.searchParams.set('room', room);
				history.replaceState(null, '', url.href);
			}

			let username = prompt('Enter your username:');
			if (!username || username.trim() === '') {
				username = "Anonymous";
			}

			let ws;
			const messageContainer = document.getElementById('messageContainer');
			const statusElement = document.getElementById('connectionStatus');

			const wsUrl = location.origin.replace(/^http/, 'ws') + '/ws';

			function generateRandomId() {
				return Math.random().toString(36).substring(2, 15);
			}

			function connect() {
				ws = new WebSocket(`${wsUrl}?name=${username}&room=${room}`);

				ws.onopen = () => {
					statusElement.textContent = 'Status: Connected';
					addMessage('System', `Connected to room ${room} as ${username}`);
				};

				ws.onmessage = (event) => {
					console.log(event.data);
					const parsed = JSON.parse(event.data);
					addMessage(parsed.name, parsed.message);
				};

				ws.onerror = (error) => {
					console.error('WebSocket error:', error);
					addMessage('Error', 'Connection error occurred');
				};

				ws.onclose = () => {
					statusElement.textContent = 'Status: Disconnected';
					addMessage('System', 'Disconnected');
				};
			}

			function sendMessage(evt) {
				evt.preventDefault();

				const messageInput = document.getElementById('messageInput');
				const message = messageInput.value.trim();

				if (message && ws && ws.readyState === WebSocket.OPEN) {
					const payload = JSON.stringify({
						message: message,
					});
					ws.send(payload);
					addMessage(username, message);
					messageInput.value = '';
				}
			}

			function disconnect() {
				if (ws && ws.readyState === WebSocket.OPEN) {
					ws.close();
					statusElement.textContent = 'Status: Disconnected';
					addMessage('System', 'Manually disconnected from server');
				}
			}

			function addMessage(source, message) {
				const messageElement = document.createElement('div');
				messageElement.textContent = `${source}: ${message}`;
				messageContainer.appendChild(messageElement);
				messageContainer.scrollTop = messageContainer.scrollHeight;
			}

			// Connect when the page loads
			connect();
		</script>
	</body>
</html>
